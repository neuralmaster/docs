# FAQ

Ситуация меняетя очень оеративно, и поэтом многие их пеерчисленных рекомендаций могут сильно устаревать.
Пожалуйста, сообщите мне, если видете здесь неточность.

### Главные рекомендации

1. Всегда используйте controlnet depth + normal map для точного совпадения геометрии и текстуры
2. Используйте маску Canny или Scribble (c препрочессором xdog) для сохранения рисунка текстуры
3. Используйте референсные изображения, причем, желательно при помощи модуля Controlet IP adapter plus, но не ip adapter и не reference.
4. Используйте по возможности ортографическую камеру.
5. Сохраняйте хорошие сиды, и возращайтесь к ним, если появились проблемы. Но не пытайтесь зафиксировать один и то же сид на всю модель, долгосрочно это не работает.
6. Делайте больше итераций.
7. Используйте модель SD 1.5, а не SDXL, поскольку для первой существует больше моделей ControlNet
8. Если вы используете несколько Conrolnet units, увеличьте количество шагов генерации. Чем больше юнитов, тем больше шагов.

## Как добиться точного наложения текстуры на модель

1. Используйте одновременно две маски ControlNet: Normal Map и Depth map. 
NeuralMaster создает обе эти маски по умолчанию на стадии рендера слоя (если вы не отключили их в настройках).

2. Насколько известно автору плагина, в текущий момент не существует NormalMap Controlnet для SDXL, поэтому лучше использовать SD 1.5 или одну из кастомных моделей, сделанных на ее основе (например, Deliberate, Photon и т.д.)

3. Если нужно использовать XDSL (например, важен высокий резолюшен), можно попробовать SDXL без маски нормалей, только с Depth.
В этом случае попробуйте также включить Controlnet Canny Edge, а на вход его препроцессора подать маску Френеля или Ambient Occlusion (которые также по умолчанию создаются на стадии рендера).
Но результат будет скорее всего хуже.

4. Поддерживайте промптом настройки камеры. Например, при использовании орографической камеры неплохо дописать low angle

## Как добиться консистентности текстуры

1. Используйте референсные избражения.
2. Старайтесь сделать 1-й кадр как можно большего резолюшена и далее отталкивайтесь от него при детализации отдельных участков текстуры.
2. Если ваша модель симметрична или почти симметрична, первым кадром текстурируйте обе ее половины.
5. Если у модели есть симметричные детали, уже хорошо затекстурированные с одной стороны, копируйте их на другую сторону рпежиме imj2img, при помиощи установки симметричной камеры и зеркалирования входного изображения.
6. Используйте модель Lora, в том чсиле свою кастомную модель, которую вы можете обучить под вашу задачу на основе ваших референсных изображений.
7. Используйте сильный промпт, который задает однородный стиль, мало зависящицй от ракурса камеры и сида.

### Как использовать референсное изображение

Суть задачи.
Вы можете использовать некоторое референсное изображение или даже несколько изображений, чтобы добиться желаемого внешнего вида модели.
Это позволяет повысить косистентность, качество, и уменьшить количество итераций.
Например, при текстурировании животного одно изображение может задавать делаемый внешний вид животного целиком, а второе передавать структуру и мелкий рисунок его шерсти.

1. Простейший способ установить референсное изображение - использовать главную панель управления NeuralMaster. 
Этот селектор - интеллектуальный хелпер. Он анализирует конфигурацию вашего SD, а далее выбирает (или создает) подходящий контролнет юнит, и применяет его.
Если в конфигурации обнаружен P Adapter Plus, то используется он, иначе - IP Adapter, иначе - Reference, затем любой другой IP adapter.  
На старте старта работы этого достаточно. Однако, вам надо разобратсья более детально в настройках ControlNet и позже настраивать controlnet самостоятельно.
2. Самые елучшие результаты (на наш взгляд) дает  ControlNet IP Adapter Plus, старайтесть использовать его. Он существует и для SD 1.5 и для SDXL.
Модели IP adapter появились недавно и отсутствуют во многих сборках Automatic1111, и их надо досутановить самостоятельно. 
Вы можете использовать вот этот python-скрипт для установки сразу всех доступных моделей IP adapter. В скрипте укажите правильный путь к вашей папке с моделями ControlNet.
4. Если у вас не установлены IP адаптеры, используйте модель Reference, которая, скорее всего, присутствует. 
5. Используйте использовать референсное изображение, подходящее для вашего ракурса - ориентированное примерно так же.
Если, например, вы текстурируете животное слева, то нежелательно использовать его фотографию спереди или справа. 
Или, например, если шерстинки должны идти в кадре приблизительно слева направо, а в референсе они идут сверху вниз, то лучше поверните референсную текстуру на 90 градусов.    
6.  Масштаб элементов желемйого изображения должен примерно совпадать с масштабом в рефенерсной текстуре.
8. Советы по использованимею нескольких референсных изображенйи одновременно перечислены ниже


### Как использовать одновременно несколько референсных изображений 

Зачастую возникает желание использовать несколько референсных изображений
Например, одно из них передает общий вид изображения, а второй - структуру мелких деталей(текстура шерсти, например).

1. Можно настроить несколько IP адаптеров, но толдько один из них может быть адаптером IP Adapter plus, другие должны быть IP adapter.
2. Надо правильно настроить параметры IP адаптеров и, в первую очеред параметры start step и end step, котоыре меняются в диапазоне от 0 до 1.
   Stable diffusion создает изображение в несколько шагов что задается параметром steps в настройках
   На начальных шагах генерируются самые крупные детали, а потом они уже детализируются
   Поэтому маска, передающая более крупные детали должан использоваться, приемуществено на начальных шагах, а маска более мелких деталей - приемущественно, на более поздних шагах. 
3. генерирует самые крупные детали,

При содании маски
1. Постарайтесь создать маску как можно более однородной по цвету/свету
2. Создайте маску большого размера, который подходит оптимальным образом для использованной модели SD. для модели SD 1.5 это 512*512 до 768*768.


### Симметричное текстурирование боковой камерой

Этот способ хорошо подходит для самого первого текстурного слоя симметричной модели, а также для текстурированяи головы.

1. Используйте ортографическую камеру, установленную перпендикулярно плоскости симметрии камеры.
2. Установите масштаб камеры, чтобы площадь модели в кадре была как можно больше - чтобы максимально использовать все пиксели изображения.
3. Добейтесь высокого разрешения кадра.

### Симметричное текстурирование камерой в анфас

Этот способ хорошо подходит для текстурирования лица и отдельных его деталей, в режимах txt2img, img2img, inpaint.  

1. Используйте ортографическую камеру, установленную в плоскости симметрии камеры.
2. Установите камеру максимально перпендикулярно текстурируемой поверхности.
3. Используй промпт, подчеркивающий симметрию.
3. В режиме inpaint лучше использовать симметричную маску.
4. Выполни несколько итераций, выбери нужную.

### Симметричное текстурирование зеркалированием предыдущего кадра

Это технически наиболее сложный способ текстурирования.
Он бывает полезен, когда надо создавать симметричные участки текстуры
Например, он полезен для текстурирования участков морды животного или человека, котоыре получаются слишком растянутыми при использовании ортогональной камеры.  



### Как исправить неправильный цвет на краях текстуры, где нормали почти перпендикулярны оси камеры

Суть проблемы.
В моделях натуральных объектов имеющие округлые формы всегда будут участки, где нормали к поверхности почти перпендикулярны к оси камеры.
Такая граница как минимум проходит по внешнему контуру модели
Текстура всегда очень сильно растянута на этих участках.
Кроме того, в режиме txt2img нейросеть SD всегда создает кадр, где ваша модель стоит на некотором фоне, и цвет этого фона зачастую залезает на самый край модели. 
Поэтому текстура там не только растянута, но и имеет совершенно другой цвет.  
Например, очень часто, при текстурировании животных, фон - зеленые деревья или трава, и поэтому стык между половинками текстуры будет зеленый.
Вот пример такого стыка при текстурировании тигра.

Что делать
1. Старайтесь не текстурировать такие участки. В режиме инпаинт нарисуйте маску таким образом, чтобы она не попадала на эти участки.
2. Отсекайте эти участки при помощи порога по маске Френнеля (создается по умолчанию при рендере). По умолчанию уже установлено сечение по значению маски френнеля = 0.3. Поэкспериментируйте с этим значением, чтобы лучше понять его суть. 
Если появление границы неизбежно (например, при рендере первого кадра), есть насколько способов устранения такого стыка
1. Избегайте стыка с неверным цветом. Чтобы этого добиться можно:
   1.1. Создать начальную грубую текстуру объекта и генерировать кадр в режиме img2img.
   1.2. Пишите в промпте цвет фона, совпадающий с основным цветом вашей модели.
   1.3. Используйте референсное изображение на нейтральном фоне.
2. Устраните контрастный шов после его появления, для чего создайте следующий кадр с точно такой же камерой, и со все ми те ми же параметрами SD, которые вы использовали в первом кадре. 
НО: в режиме img2img, и установите цвет фона, совпадающий с основным цветом вашей модели.
Если, однако, вы использовали апскейлер дял создания первого кадра, то в режиме imgtimg вам не получится добиться такого же изображения с таким же высоким резолюшеном, и это проюблема - стык улучшен, но качества кадра понизилось.
В данном следует просто пересортировать кадры в другом порядке - сначала в списке поставить второй кадр, с замазанным стыком, 
а затем уже главный кадр, полученный первым. Вам также потреубется опять поменять параметр Normals Angle второго слоя на значение ~0.8 (точное значение подобрать экспериментально), чтобы первый кад просвечивал через него в месте стыка.  

### Как добиться высокого резолюшена текстуры с высокой детализацией

1. Создавайте 1-й кадр высокого резолюшена
2. Для детализации деталей используйте референсную маску высокого резолюшена. SD 1.5 отлично справляется с маской 512*512, а во многих случаях и 768*768.
4. Используйте референсные изображения
4. Делайте больше детализирующих снимков.
5. Используйте сильный промпт
6. Используйте lora

### Как добиться высокого резолюбшена и вссокой детализации кадар в режиме txt2img

1. Добейтесь высокого резолюшена первого кара текстурного слоя
2. Если вам достаточно дрезорлюшена 1024*1024 (во многиз случаях это так), используйте  SD 1.5, а не SDXL.
В разных источниках написано, что сеть SD 1.5 не позволяет генерировать изображения 1024*1024, но, по нашему опыту,
при использовании ControlNet Depth + ControlNet Normal, модель 1.5 отлично работает с этим резолюшеном, хотя и делает это медленнее чем SDXL и, кажется, потребляет много памяти.
(Но эти ограничения будут вряд ли критичны для вас, если вы использщуете внещшний хостенг SD - вам надо будет выбрать чуть хостинг подороже всего на непродолжительное время - пока вы генерируете первые два-три кадра).  
3. Если же резолющена 1024*124 вам недостаточно, существует два способа его повысить.
- Использовать модель SDXL (здесь могут быть проблемы наложения текстуры на меш из-за отсуствия маски Normal XDSL, однако можно попробовать, используя рекомендацию, приведенную в разделе "Как добиться точного наложения текстуры на модель").
- Использовать SD1.5 + апскейлер
5. Сочетание SD 1.5 + Upscaler позволяет добиться резолюшена 2048*2048 с высокой степеью детализации. Текущая версия Neural Master Не поддерживает апскейлер (планируем добавить поддерку в ближайший месяц), однако вы можетеапскейлить полученное изображение через Web интерфейс Automatic 1111.  
Будьте готовы, что апскейлер не только повысит резолюшен изображения, но и существенно изменит его, и вам потреубется еще несколько итераций для того, чтобы добиться желаемого результата.
6. При необходимости получить текстуру разрешения 4096*4096 попробовать использовать SDXL + Upscaler.
7. В некоторых случаях можно добиться 4096*4096, проапскейлив изображение SD 1.5 в 4 раза, но, сворее всего, оно слишком сильно будет отличаться от оригинала.
8. В негативный промпт добавьте: blur

### Уточнение деталей

После созданию начальных кажров создания референсной маски приступаем к текстурированию поверхности модели по всей поверхности.

1. Исопльзуйте референсную маску.
2. Изначально вам потреубется немало итераций, чтобы добиться правильного результата текстурирования. Не растраивайтесь, если с первого раза не получилось.
2. Помимо маски пишите промпт, не забывайте его редактировать, когда переходите от одного сида к другому.
3. Постарайтесь зафиксировать сид, по крайней мере на непродолжителдьное время - сид неплохо созраняет однородность хоя бы нескольких соседних участков текстуры, что уже неплохо.
Но не пытайтесь зафиксировать один сид навсегда - меняйте его, как только видите какие-то пролемы. Хорошие сиды помечайте как любисмые, и доабвляйте к ним комментарий - Neural Master Это позволяет сделать.
4. Правильно выбирайте масштаб деталей в камере, соответствующий масштабу маски, поскольку размер деталей, которые вы хотите получить при текстурировании, 
будет  примерно совпадать с размером деталей в маске. Например, если в вашей маске расположено 1000 шерстинок вдоль ее горизонтали, то и в полученной текстуре будет также примерно 1000 шерстинок вдоль горизонтали. 
6. Направление текстуры в кадре также должно примерно совпадать с маской, хотя бы с точностью до +-45 градусов. Если, например, вы хотите, чтобы шерстинки были расположены сверху-вниз, 
а в маске они расположены слева-направо, то для достижения желаемого результата, лучше разверните маску на 90 градусов (что делается параметрами NeuralMaster, текстуру маски менять не надо).
7. Одновременно с маской IP Adapter используйте маски ControlNet, позволяющие сохранить правильный объем (Normal, Dapth), а также правильный рисунок модели (Canny, Scribble).
Вероятно, вам надо будет подобрать правильные параметры маски Canny, чтобы она не пыталась передавать слишком мелкие детали, а только основной рисунок текстуры. 


### Текстурирование лица (морды)

Если вы создаете симметричную модель, то первым кадром вы текстурируете ее бока, поэтому текстура на лице (морде), будет совершенно растянутым, и его надо текстурировать заново.
1. Попробуйте затекстурировать его в режиме txt2img, с подходящими референсными изображениями, чтобы добиться неплохой стыковки с уже существующими деталями. Зачастую десятка итераций бывает достаточно, чтобы получить хороший результат.
2. Также можно попробовать режим impaint fill
2. В полученном текстурном слое текстуры настройте отсечение по глубине, чтобы текстура не заползала на лишние детали, например, на плечи.
3. Когад первый кадр (фас) сделан, необходимо передвинуть камеру, что уточнить детали на стыках, и, в этом случае, сложно добиться симметрии левой и правой части. 
Чтобы скопировать фрагмент текстуры с одной стороны сторны на другую можно использовать такой способ. После создания текстуры с одной стороны,
создайте новый кадр в режиме inpaint или img2img, разместите его камеру строго симметрично предыдущему (используя точные настройки камеры), 
в качестве входного изображения (и возможно, маски инпаинта) передайте на вход результат и маску инпаинта предыдущего кадра, но отзеркалированные.
Используйте параметр denoising strenght, чтобы настроить степень совпадения левого и правого участка лица.4. 

## Как ускорить процесс текстурирования

1. Используйте по возможности ортографическую камеру, поскольку именно такая камера позволяет текстурировать модель сразу с двух сторон простейшим способом и, кроме того,
такая камера лучше "видит" боковые поверхности модели, что позволяет создать текстуру максимальной полезной площади.

2. Но выбирайте камеру, исходя из задачи. Если, например, вы текстурируете внутренню поверхность модели, например, интерьер помещения, то лучшим выбором, возможно, будет перспективная камера с большим FOV.

3. Place the camera on one side of the model so that it is strictly perpendicular to the plane of symmetry and the model occupies the camera viewport as much as possible. Some minor details of the model (for example, the tail) may extend beyond the camera - these can be textured later.
Чтобы установить камеру максимально точно, задайте параметры камеры вручную, при помощи стандартной панели Blendera.

4. Используйте режим Txt2img, если у вашей модели нет исходной текстуры или режим Img2img, если некоторая начальная текстура существует.
Начальная текстура, как правило, позволяет добиться лучшей консистентности модели и потратить меньше итераций (и, следовательно, вашего времени, а также стоимости хостинга)
на текстурирование. Мы рекомендуем вам потратить 15-30 минут для создания такой грубой текстуры.  

5. Используйте модель В 1.5,поскольку для нее существует множество вариантов ControlNet 

5. Чтобы добиться идеального совпадения текстуры и используйте одновременно две маски ControlNet: Normal Map и Depth map.

6. При уточнении деталей вытянутых деталей модели (руки, ноги, хвост и т.д.) вы будете накладывать маску длинными узкими кусками. лучше в этой ситуации использовать соотношенеи сторон камеры 2:1 или 1:2, но не квадрат.
   (Однако в этом случае вам надо будет создать референсное изображение такого же размера).


### Как стилезовать уже готовую текстуру

1. Используйте IP adapter, где в качестве референсного изображения указана текстура стиля.
2. Используйте в частке текстуры стиля что-то близкое альбедо
3. Используйте лору

### Как добиться результата, близкого к натуральному альбедо

1. Добавьте в промпт слова: albedo, 
2. Добавьте в негативный промпт: metallic, specular, transparent, reflection 
3. Используте референсные изображения  с цветами, близкими к альбедо


## Прочие вопросы 

